generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  GUEST
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Уроки, которые ведёт преподаватель
  lessons     Lesson[]     @relation("TeacherLessons")
  // Комнаты, которые он создал
  roomsOwned  Room[]       @relation("OwnerRooms")
  // Членство в комнатах
  memberships RoomMember[]

  messagesAuthored Message[] @relation("UserMessages")

  chatSessionsAsStudent ChatSession[] @relation("ChatSessionStudent")
  chatSessionsAsTeacher ChatSession[] @relation("ChatSessionTeacher")
  QuizAttempt           QuizAttempt[]

  subjectLinks SubjectStudent[]
}

model Subject {
  id        String   @id @default(uuid())
  title     String
  modules   Module[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students SubjectStudent[]
  groups   StudentGroup[]
}

model Module {
  id        String   @id @default(uuid())
  title     String
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  parentId  String?
  parent    Module?  @relation("SubModules", fields: [parentId], references: [id])
  children  Module[] @relation("SubModules")
  lessons   Lesson[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id        String   @id @default(uuid())
  title     String
  content   String?
  modelUrl  String?
  teacherId String
  teacher   User     @relation("TeacherLessons", fields: [teacherId], references: [id])
  moduleId  String?
  module    Module?  @relation(fields: [moduleId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Quiz      Quiz?
}

model Room {
  id      String  @id @default(uuid())
  code    String  @unique
  title   String?
  ownerId String
  owner   User    @relation("OwnerRooms", fields: [ownerId], references: [id])

  messages     Message[]
  members      RoomMember[]
  chatSessions ChatSession[]

  bgColor    String? @default("#FFFFFF")
  bgImageUrl String?
}

model RoomMember {
  id     String @id @default(uuid())
  roomId String
  userId String

  room Room @relation(fields: [roomId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
}

model Message {
  id            String   @id @default(uuid())
  authorId      String?
  text          String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  roomId        String?
  chatSessionId String?

  room        Room?        @relation(fields: [roomId], references: [id])
  chatSession ChatSession? @relation(fields: [chatSessionId], references: [id])
  author      User?        @relation("UserMessages", fields: [authorId], references: [id])
  attachments Attachment[]
}

model Attachment {
  id        String  @id @default(uuid())
  url       String
  message   Message @relation(fields: [messageId], references: [id])
  messageId String

  createdAt DateTime @default(now())
}

model ChatSession {
  id        String   @id @default(uuid())
  roomId    String
  studentId String
  teacherId String
  createdAt DateTime @default(now())

  room     Room      @relation(fields: [roomId], references: [id])
  student  User      @relation("ChatSessionStudent", fields: [studentId], references: [id])
  teacher  User      @relation("ChatSessionTeacher", fields: [teacherId], references: [id])
  messages Message[]
}

model Quiz {
  id       String @id @default(uuid())
  lessonId String @unique
  lesson   Lesson @relation(fields: [lessonId], references: [id])

  title       String  @default("Тест по уроку")
  isPublished Boolean @default(false)

  passThreshold    Int     @default(70) // проходной порог (0–100)
  maxAttempts      Int? // null = бесконечно
  shuffleQuestions Boolean @default(false)
  shuffleOptions   Boolean @default(false)
  timeLimitSec     Int? // null = без ограничений

  questions QuizQuestion[]
  attempts  QuizAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuizQuestion {
  id     String @id @default(uuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id])

  order       Int
  type        QuestionType
  text        String
  explanation String? // показываем после проверки (опционально)

  points   Int     @default(1)
  required Boolean @default(true)

  options QuizOption[]

  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  QuizAnswer QuizAnswer[]
}

model QuizOption {
  id         String       @id @default(uuid())
  questionId String
  question   QuizQuestion @relation(fields: [questionId], references: [id])

  order     Int
  text      String
  isCorrect Boolean @default(false)

  createdAt DateTime @default(now())
}

model QuizAttempt {
  id     String @id @default(uuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  tryIndex    Int
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  durationSec Int?

  score   Int     @default(0)
  percent Int     @default(0)
  passed  Boolean @default(false)

  answers QuizAnswer[]

  createdAt DateTime @default(now())
}

model QuizAnswer {
  id        String      @id @default(uuid())
  attemptId String
  attempt   QuizAttempt @relation(fields: [attemptId], references: [id])

  questionId String
  question   QuizQuestion @relation(fields: [questionId], references: [id])

  // SINGLE / DROPDOWN
  selectedOptionId String?

  // MULTI
  selectedOptionIds String[] @default([])

  // TEXT
  textValue String?

  isCorrect Boolean?

  createdAt DateTime @default(now())
}

enum QuestionType {
  SINGLE // один верный вариант
  MULTI // несколько верных вариантов
  SHORT_TEXT // ответ вводится вручную
  DROPDOWN // выбрать из списка (как SINGLE, но UI другой)
}

model LessonProgress {
  id               String            @id @default(uuid())
  lessonId         String
  userId           String
  completedAt      DateTime?
  completionReason CompletionReason?

  @@unique([lessonId, userId])
}

enum CompletionReason {
  PASSED_QUIZ
  SCROLLED_TO_END
}

model SubjectStudent {
  id        String  @id @default(uuid())
  subjectId String
  userId    String
  groupId   String?

  subject Subject       @relation(fields: [subjectId], references: [id])
  user    User          @relation(fields: [userId], references: [id])
  group   StudentGroup? @relation(fields: [groupId], references: [id])

  createdAt DateTime @default(now())

  @@unique([subjectId, userId]) // студент может быть в предмете только один раз
  @@index([groupId])
  @@index([userId])
  @@index([subjectId])
}

model StudentGroup {
  id        String @id @default(uuid())
  name      String
  subjectId String

  subject  Subject          @relation(fields: [subjectId], references: [id])
  students SubjectStudent[]

  createdAt DateTime @default(now())

  @@index([subjectId])
}
